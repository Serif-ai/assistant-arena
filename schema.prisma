// schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL") // uses connection pooling
  directUrl = env("POSTGRES_URL_NON_POOLING") // uses a direct connection
}

model User {
  id        String   @id @default(cuid())
  ip        String?  @unique
  createdAt DateTime @default(now())
  votes     Vote[]

  @@index([ip])
}

model EmailThread {
  id          String       @id @default(cuid())
  messages    Json[]
  groundTruth Json         @default("{}")
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  responses   AIResponse[]
  votes       Vote[]
}

model Model {
  id           String       @id @default(cuid())
  name         String
  organization String
  eloRating    Int         @default(1500)
  responses    AIResponse[]
  votesWon     Vote[]      @relation("winnerModel")
  votesLost    Vote[]      @relation("loserModel")
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  @@unique([name, organization])
  @@index([organization])
}

model AIResponse {
  id           String      @id @default(cuid())
  content      String
  threadId     String
  thread       EmailThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  modelId      String
  model        Model       @relation(fields: [modelId], references: [id])
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  @@index([threadId])
  @@index([modelId])
}

model Vote {
  id              String      @id @default(cuid())
  userId          String
  user            User        @relation(fields: [userId], references: [id])
  threadId        String
  thread          EmailThread @relation(fields: [threadId], references: [id])
  winnerModelId   String
  winnerModel     Model       @relation("winnerModel", fields: [winnerModelId], references: [id])
  loserModelId    String
  loserModel      Model       @relation("loserModel", fields: [loserModelId], references: [id])
  timeToVote      Int         // in seconds
  createdAt       DateTime    @default(now())

  @@index([userId])
  @@index([threadId])
  @@index([winnerModelId])
  @@index([loserModelId])
}
